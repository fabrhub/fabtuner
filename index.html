<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <title>FabTuner</title>
</head>
<body>
    <div id="fabtuner"
        style="width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div id="fabtuner-widget">
            <style>
                #fabtuner-widget {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
                    color: #f5f5f5;
                    --font-multiplier: 1.25;
                }

                #fabtuner-widget .fabtuner-card {
                    width: 100%;
                    max-width: 720px;
                    margin: 1.5rem auto;
                    background: #111827;
                    border-radius: 1.25rem;
                    padding: 1.5rem 1.7rem;
                    box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
                    box-sizing: border-box;
                }

                #fabtuner-widget h2 {
                    margin: 0 0 0.15rem;
                    font-size: calc(1.4rem * var(--font-multiplier));
                    display: flex;
                    align-items: baseline;
                    justify-content: space-between;
                }

                #fabtuner-widget .fabtuner-subtitle {
                    font-size: calc(0.8rem * var(--font-multiplier));
                    opacity: 0.7;
                    margin-bottom: 1rem;
                }

                #fabtuner-widget button.fabtuner-btn {
                    border: none;
                    border-radius: 999px;
                    padding: 0.55rem 1.35rem;
                    font-size: calc(0.9rem * var(--font-multiplier));
                    cursor: pointer;
                    background: #f97373;
                    color: #111827;
                    font-weight: 600;
                    display: inline-flex;
                    align-items: center;
                    gap: 0.4rem;
                }

                #fabtuner-widget button.fabtuner-btn:disabled {
                    opacity: 0.5;
                    cursor: default;
                }

                #fabtuner-widget .fabtuner-row {
                    display: flex;
                    gap: 1rem;
                    margin: 1rem 0 0.6rem;
                }

                #fabtuner-widget .fabtuner-block {
                    flex: 1;
                    background: rgba(15, 23, 42, 0.8);
                    padding: 0.7rem 0.9rem;
                    border-radius: 0.9rem;
                    box-sizing: border-box;
                }

                #fabtuner-widget .fabtuner-label {
                    font-size: calc(0.75rem * var(--font-multiplier));
                    text-transform: uppercase;
                    letter-spacing: 0.08em;
                    opacity: 0.65;
                    margin-bottom: 0.2rem;
                }

                #fabtuner-widget .fabtuner-value-main {
                    font-size: calc(1.6rem * var(--font-multiplier));
                    font-weight: 700;
                    line-height: 1.2;
                }

                #fabtuner-widget .fabtuner-value-sub {
                    font-size: calc(0.9rem * var(--font-multiplier));
                    opacity: 0.8;
                    margin-top: 0.15rem;
                }

                #fabtuner-widget .fabtuner-note {
                    font-size: calc(1.8rem * var(--font-multiplier));
                    font-weight: 700;
                }

                #fabtuner-widget .fabtuner-cents {
                    font-size: calc(0.9rem * var(--font-multiplier));
                    margin-top: 0.25rem;
                }

                #fabtuner-widget .fabtuner-status {
                    font-size: calc(0.8rem * var(--font-multiplier));
                    opacity: 0.8;
                    margin-top: 0.4rem;
                }

                #fabtuner-widget .fabtuner-section {
                    margin-top: 1rem;
                    padding-top: 0.8rem;
                    border-top: 1px solid rgba(148, 163, 184, 0.35);
                }

                #fabtuner-widget .fabtuner-section-title {
                    font-size: calc(0.9rem * var(--font-multiplier));
                    font-weight: 600;
                    margin-bottom: 0.4rem;
                }

                #fabtuner-widget .fabtuner-slider-row {
                    display: grid;
                    grid-template-columns: auto 1fr auto;
                    align-items: center;
                    gap: 0.6rem;
                    width: 100%;
                    max-width: 560px;
                }

                #fabtuner-widget input.fabtuner-slider {
                    width: 100%;
                    accent-color: #f97373;
                }

                #fabtuner-widget .fabtuner-slider-value {
                    font-weight: 600;
                    font-size: calc(0.85rem * var(--font-multiplier));
                }

                #fabtuner-widget .fabtuner-inline {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                }

                #fabtuner-widget input.fabtuner-input {
                    background: #020617;
                    border-radius: 999px;
                    border: 1px solid rgba(148, 163, 184, 0.6);
                    padding: 0.35rem 0.75rem;
                    font-size: calc(0.85rem * var(--font-multiplier));
                    color: #e5e7eb;
                    outline: none;
                    min-width: 0;
                }

                #fabtuner-widget input.fabtuner-input:focus {
                    border-color: #f97373;
                    box-shadow: 0 0 0 1px rgba(249, 115, 115, 0.4);
                }

                #fabtuner-widget .fabtuner-help {
                    font-size: calc(0.75rem * var(--font-multiplier));
                    opacity: 0.7;
                    margin-top: 0.3rem;
                }

                #fabtuner-widget .fabtuner-target-list {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.35rem;
                    margin-top: 0.5rem;
                }

                #fabtuner-widget .fabtuner-pill {
                    font-size: calc(0.78rem * var(--font-multiplier));
                    padding: 0.2rem 0.55rem;
                    border-radius: 999px;
                    background: rgba(15, 23, 42, 0.9);
                    border: 1px solid rgba(148, 163, 184, 0.5);
                    display: inline-flex;
                    align-items: baseline;
                    gap: 0.25rem;
                }

                #fabtuner-widget .fabtuner-pill span.fabtuner-pill-note {
                    font-weight: 600;
                }

                #fabtuner-widget .fabtuner-pill.fabtuner-pill-active {
                    background: rgba(248, 113, 113, 0.16);
                    border-color: #f97373;
                    color: #fecaca;
                }

                #fabtuner-widget .fabtuner-target-status {
                    font-size: calc(0.8rem * var(--font-multiplier));
                    margin-top: 0.45rem;
                    opacity: 0.9;
                }

                #fabtuner-widget .fabtuner-guidance {
                    margin-top: 0.6rem;
                }

                #fabtuner-widget .fabtuner-guidance input[type="range"] {
                    width: 100%;
                    accent-color: #f97373;
                }

                #fabtuner-widget .fabtuner-guidance-label {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 0.35rem;
                    font-size: calc(0.85rem * var(--font-multiplier));
                    font-weight: 600;
                }

                #fabtuner-widget .fabtuner-guidance-helper {
                    font-size: calc(0.75rem * var(--font-multiplier));
                    opacity: 0.7;
                    margin-top: 0.25rem;
                }

                #fabtuner-widget .fabtuner-presets {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.4rem;
                    margin-top: 0.4rem;
                }

                #fabtuner-widget .fabtuner-chip {
                    border: 1px solid rgba(148, 163, 184, 0.5);
                    background: rgba(15, 23, 42, 0.9);
                    border-radius: 999px;
                    padding: 0.35rem 0.7rem;
                    font-size: calc(0.82rem * var(--font-multiplier));
                    cursor: pointer;
                    transition: background 120ms ease, border-color 120ms ease;
                }

                #fabtuner-widget .fabtuner-chip:hover {
                    background: rgba(248, 113, 113, 0.14);
                    border-color: #f97373;
                }

                #fabtuner-widget .fabtuner-chip.fabtuner-chip-active {
                    background: rgba(248, 113, 113, 0.16);
                    border-color: #f97373;
                    color: #fecaca;
                }

                #fabtuner-widget .fabtuner-target-status strong {
                    font-weight: 600;
                }

                @media (max-width: 480px) {
                    #fabtuner-widget .fabtuner-card {
                        margin: 1rem;
                        padding: 1.1rem 1.2rem;
                    }

                    #fabtuner-widget .fabtuner-row {
                        flex-direction: column;
                    }
                }
            </style>

            <div class="fabtuner-card">
                <h2>
                    FabTuner
                    <button class="fabtuner-btn" type="button" data-fabtuner="start">
                        üéôÔ∏è Start
                    </button>
                </h2>
                <div class="fabtuner-subtitle">
                    Experimental tuner ‚Äì uses the microphone (HTTPS required).
                </div>

                <div class="fabtuner-row">
                    <div class="fabtuner-block">
                        <div class="fabtuner-label">Detected frequency</div>
                        <div class="fabtuner-value-main" data-fabtuner="freq">-- Hz</div>
                        <div class="fabtuner-value-sub fabtuner-status" data-fabtuner="status">
                            Waiting‚Ä¶
                        </div>
                    </div>
                    <div class="fabtuner-block">
                        <div class="fabtuner-label">Estimated note (global)</div>
                        <div class="fabtuner-note" data-fabtuner="note">--</div>
                        <div class="fabtuner-cents" data-fabtuner="cents"></div>
                    </div>
                </div>

                <div class="fabtuner-section">
                    <div class="fabtuner-section-title">Reference frequency A4</div>
                    <div class="fabtuner-inline">
                        <input
                            class="fabtuner-input"
                            type="number"
                            min="400"
                            max="480"
                            step="0.1"
                            value="440"
                            data-fabtuner="a4"
                        />
                        <span class="fabtuner-help">Default 440 Hz ‚Äì used to compute notes and targets.</span>
                    </div>
                </div>

                <div class="fabtuner-section">
                    <div class="fabtuner-section-title">Input filtering</div>
                    <div class="fabtuner-slider-row">
                        <div class="fabtuner-label" aria-hidden="true">Smoothing</div>
                        <input
                            class="fabtuner-slider"
                            type="range"
                            min="0"
                            max="0.9"
                            step="0.05"
                            value="0.35"
                            data-fabtuner="smoothing"
                            aria-label="Input smoothing factor"
                        />
                        <div class="fabtuner-slider-value" data-fabtuner="smoothing-value">0.35</div>
                    </div>
                    <div class="fabtuner-help">Higher values reduce jitter but react more slowly.</div>
                </div>

                <div class="fabtuner-section">
                    <div class="fabtuner-section-title">Target notes</div>
                    <div class="fabtuner-inline">
                        <input
                            class="fabtuner-input"
                            type="text"
                            value="E2 A2 D3 G3 B3 E4"
                            placeholder="E2 A2 D3 G3 B3 E4"
                            data-fabtuner="targets-input"
                        />
                        <button class="fabtuner-btn" type="button" data-fabtuner="apply-targets">
                            Apply
                        </button>
                    </div>
                    <div class="fabtuner-help">
                        Enter notes separated by spaces or commas (e.g. <code>E2 A2 D3 G3 B3 E4</code>).
                    </div>
                    <div class="fabtuner-target-list" data-fabtuner="targets-list"></div>
                    <div class="fabtuner-presets" data-fabtuner="presets"></div>
                    <div class="fabtuner-help">Select a preset to quickly load common tunings.</div>
                    <div class="fabtuner-target-status" data-fabtuner="target-status">
                        No detection relative to target notes yet.
                    </div>
                    <div class="fabtuner-guidance">
                        <div class="fabtuner-guidance-label">
                            <span>Pitch guidance</span>
                            <span data-fabtuner="guidance-value">Centered</span>
                        </div>
                        <input
                            type="range"
                            min="-50"
                            max="50"
                            step="1"
                            value="0"
                            data-fabtuner="guidance-slider"
                            aria-label="Pitch direction toward closest target"
                            disabled
                        />
                        <div class="fabtuner-guidance-helper" data-fabtuner="guidance-helper">
                            Play a target note to see if you need to raise or lower the pitch.
                        </div>
                    </div>
                </div>
            </div>

            <script>
                (function () {
                    const root = document.getElementById("fabtuner-widget");
                    if (!root) return;

                    const startBtn = root.querySelector('[data-fabtuner="start"]');
                    const freqEl = root.querySelector('[data-fabtuner="freq"]');
                    const noteEl = root.querySelector('[data-fabtuner="note"]');
                    const centsEl = root.querySelector('[data-fabtuner="cents"]');
                    const statusEl = root.querySelector('[data-fabtuner="status"]');
                    const a4Input = root.querySelector('[data-fabtuner="a4"]');
                    const targetsInput = root.querySelector('[data-fabtuner="targets-input"]');
                    const applyTargetsBtn = root.querySelector('[data-fabtuner="apply-targets"]');
                    const targetsListEl = root.querySelector('[data-fabtuner="targets-list"]');
                    const targetStatusEl = root.querySelector('[data-fabtuner="target-status"]');
                    const smoothingInput = root.querySelector('[data-fabtuner="smoothing"]');
                    const smoothingValueEl = root.querySelector('[data-fabtuner="smoothing-value"]');
                    const guidanceSlider = root.querySelector('[data-fabtuner="guidance-slider"]');
                    const guidanceValueEl = root.querySelector('[data-fabtuner="guidance-value"]');
                    const guidanceHelperEl = root.querySelector('[data-fabtuner="guidance-helper"]');
                    const presetsEl = root.querySelector('[data-fabtuner="presets"]');

                    let audioContext = null;
                    let analyser = null;
                    let dataArray = null;
                    let running = false;
                    let a4Ref = 440;
                    let targets = [];
                    let smoothingAmount = parseFloat(smoothingInput.value) || 0;
                    let filteredFreq = null;

                    const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F",
                        "F#", "G", "G#", "A", "A#", "B"];

                    function freqToNoteData(freq) {
                        const A4_MIDI = 69;
                        const midi = 12 * Math.log2(freq / a4Ref) + A4_MIDI;
                        const midiRounded = Math.round(midi);
                        const noteIndex = (midiRounded + 1200) % 12;
                        const octave = Math.floor(midiRounded / 12) - 1;
                        const noteName = NOTE_NAMES[noteIndex];
                        const freqFromMidi = a4Ref * Math.pow(2, (midiRounded - A4_MIDI) / 12);
                        const cents = 1200 * Math.log2(freq / freqFromMidi);
                        return { noteName, octave, cents, midiRounded, freqFromMidi };
                    }

                    function parseNoteToken(token) {
                        const t = token.trim();
                        if (!t) return null;
                        const m = t.match(/^([A-Ga-g])([b#]?)(-?\d)$/);
                        if (!m) return null;
                        let [, letter, accidental, octaveStr] = m;
                        letter = letter.toUpperCase();
                        accidental = accidental || "";
                        const octave = parseInt(octaveStr, 10);
                        const BASE = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };
                        if (!(letter in BASE)) return null;
                        let idx = BASE[letter];
                        if (accidental === "#") idx += 1;
                        if (accidental === "b" || accidental === "B") idx -= 1;
                        idx = ((idx % 12) + 12) % 12;
                        const midi = (octave + 1) * 12 + idx;
                        const freq = a4Ref * Math.pow(2, (midi - 69) / 12);
                        return {
                            token: letter + accidental + octave,
                            midi,
                            freq,
                        };
                    }

                    function rebuildTargets() {
                        const raw = (targetsInput.value || "").trim();
                        const tokens = raw.split(/[,\s]+/).filter(Boolean);
                        targets = tokens
                            .map(parseNoteToken)
                            .filter(Boolean);

                        targetsListEl.innerHTML = "";
                        if (!targets.length) {
                            targetsListEl.innerHTML =
                                '<div class="fabtuner-help">No valid target notes.</div>';
                            return;
                        }

                        const frag = document.createDocumentFragment();
                        targets.forEach((t, idx) => {
                            const pill = document.createElement("div");
                            pill.className = "fabtuner-pill";
                            pill.dataset.index = String(idx);
                            pill.innerHTML =
                                '<span class="fabtuner-pill-note">' +
                                t.token +
                                "</span><span>" +
                                t.freq.toFixed(1) +
                                " Hz</span>";
                            frag.appendChild(pill);
                        });
                        targetsListEl.appendChild(frag);
                    }

                    function highlightBestTarget(freq) {
                        const pills = targetsListEl.querySelectorAll(".fabtuner-pill");
                        pills.forEach((p) => p.classList.remove("fabtuner-pill-active"));
                        if (!targets.length || freq <= 0 || !isFinite(freq)) {
                            targetStatusEl.textContent =
                                "No detection relative to target notes yet.";
                            return null;
                        }
                        let best = null;
                        let bestDiff = Infinity;
                        let bestIndex = -1;
                        targets.forEach((t, idx) => {
                            const diff = Math.abs(freq - t.freq);
                            if (diff < bestDiff) {
                                bestDiff = diff;
                                best = t;
                                bestIndex = idx;
                            }
                        });
                        if (!best) return;

                        const bestPill = targetsListEl.querySelector(
                            '.fabtuner-pill[data-index="' + bestIndex + '"]'
                        );
                        if (bestPill) {
                            bestPill.classList.add("fabtuner-pill-active");
                        }

                        const cents = 1200 * Math.log2(freq / best.freq);
                        const centsRounded = cents.toFixed(1);
                        let arrow = "‚úì";
                        if (cents > 3) arrow = "‚Üë";
                        else if (cents < -3) arrow = "‚Üì";

                        targetStatusEl.innerHTML =
                            'Closest target: <strong>' +
                            best.token +
                            "</strong> (" +
                            best.freq.toFixed(1) +
                            " Hz) ‚Äì " +
                            arrow +
                            " " +
                            centsRounded +
                            " cents";

                        return { target: best, cents, arrow };
                    }

                    function autoCorrelate(buffer, sampleRate) {
                        const SIZE = buffer.length;
                        const MAX_SAMPLES = Math.floor(SIZE / 2);
                        let bestOffset = -1;
                        let bestCorrelation = 0;
                        let rms = 0;

                        for (let i = 0; i < SIZE; i++) {
                            const val = buffer[i];
                            rms += val * val;
                        }
                        rms = Math.sqrt(rms / SIZE);
                        if (rms < 0.01) {
                            return -1;
                        }

                        let lastCorrelation = 1;
                        for (let offset = 1; offset < MAX_SAMPLES; offset++) {
                            let correlation = 0;
                            for (let i = 0; i < MAX_SAMPLES; i++) {
                                correlation += Math.abs(buffer[i] - buffer[i + offset]);
                            }
                            correlation = 1 - correlation / MAX_SAMPLES;

                            if (correlation > 0.9 && correlation > lastCorrelation) {
                                if (correlation > bestCorrelation) {
                                    bestCorrelation = correlation;
                                    bestOffset = offset;
                                }
                            }
                            lastCorrelation = correlation;
                        }

                        if (bestCorrelation > 0.9 && bestOffset !== -1) {
                            return sampleRate / bestOffset;
                        }
                        return -1;
                    }

                    async function start() {
                        if (running) return;
                        running = true;
                        startBtn.disabled = true;
                        statusEl.textContent = "Requesting microphone access‚Ä¶";

                        try {
                            audioContext = new (window.AudioContext || window.webkitAudioContext)();
                            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            const source = audioContext.createMediaStreamSource(stream);

                            analyser = audioContext.createAnalyser();
                            analyser.fftSize = 2048;
                            dataArray = new Float32Array(analyser.fftSize);
                            source.connect(analyser);

                            statusEl.textContent = "Listening‚Ä¶ play a note.";
                            loop();
                        } catch (err) {
                            console.error(err);
                            statusEl.textContent = "Microphone access error: " + err.message;
                            startBtn.disabled = false;
                            running = false;
                        }
                    }

                    function loop() {
                        if (!running || !analyser) return;
                        analyser.getFloatTimeDomainData(dataArray);
                        const sampleRate = audioContext.sampleRate;
                        const freq = autoCorrelate(dataArray, sampleRate);

                        if (freq > 0 && isFinite(freq)) {
                            if (filteredFreq === null) {
                                filteredFreq = freq;
                            } else {
                                filteredFreq =
                                    smoothingAmount * filteredFreq +
                                    (1 - smoothingAmount) * freq;
                            }
                            const displayFreq = filteredFreq;

                            freqEl.textContent = displayFreq.toFixed(2) + " Hz";
                            const { noteName, octave, cents } = freqToNoteData(displayFreq);
                            noteEl.textContent = noteName + octave;
                            const centsRounded = cents.toFixed(1);
                            let arrow = "‚úì";
                            if (cents > 3) arrow = "‚Üë";
                            else if (cents < -3) arrow = "‚Üì";
                            centsEl.textContent = arrow + " " + centsRounded + " cents";
                            statusEl.textContent = "Signal detected.";
                            const guidance = highlightBestTarget(displayFreq);
                            updateGuidance(guidance);
                        } else {
                            freqEl.textContent = "-- Hz";
                            noteEl.textContent = "--";
                            centsEl.textContent = "";
                            statusEl.textContent = "Waiting for a stable signal‚Ä¶";
                            filteredFreq = null;
                            const guidance = highlightBestTarget(-1);
                            updateGuidance(guidance);
                        }

                        requestAnimationFrame(loop);
                    }

                    startBtn.addEventListener("click", start);

                    a4Input.addEventListener("input", function () {
                        const v = parseFloat(a4Input.value);
                        if (!isFinite(v) || v <= 0) {
                            a4Ref = 440;
                        } else {
                            a4Ref = v;
                        }
                        rebuildTargets();
                    });

                    applyTargetsBtn.addEventListener("click", rebuildTargets);
                    targetsInput.addEventListener("keydown", function (e) {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            rebuildTargets();
                        }
                    });

                    smoothingInput.addEventListener("input", function () {
                        const v = parseFloat(smoothingInput.value);
                        smoothingAmount = isFinite(v) ? v : 0;
                        smoothingValueEl.textContent = smoothingAmount.toFixed(2);
                    });

                    function updateGuidance(guidance) {
                        if (!guidance) {
                            guidanceSlider.value = 0;
                            guidanceSlider.disabled = true;
                            guidanceValueEl.textContent = "Centered";
                            guidanceHelperEl.textContent =
                                "Play a target note to see if you need to raise or lower the pitch.";
                            return;
                        }

                        const { cents, target } = guidance;
                        const clamped = Math.max(-50, Math.min(50, cents));
                        guidanceSlider.disabled = false;
                        guidanceSlider.value = clamped.toFixed(0);

                        if (cents > 3) {
                            guidanceValueEl.textContent = "Raise pitch";
                            guidanceHelperEl.textContent =
                                "Increase pitch to reach " + target.token + ".";
                        } else if (cents < -3) {
                            guidanceValueEl.textContent = "Lower pitch";
                            guidanceHelperEl.textContent =
                                "Decrease pitch to reach " + target.token + ".";
                        } else {
                            guidanceValueEl.textContent = "In tune";
                            guidanceHelperEl.textContent =
                                "You are centered on " + target.token + ".";
                        }
                    }

                    const PRESETS = [
                        { label: "Guitar ‚Äì Standard", notes: "E2 A2 D3 G3 B3 E4" },
                        { label: "Guitar ‚Äì Half Step Down", notes: "Eb2 Ab2 Db3 Gb3 Bb3 Eb4" },
                        { label: "Ukulele ‚Äì Standard", notes: "G4 C4 E4 A4" },
                    ];

                    function buildPresets() {
                        const frag = document.createDocumentFragment();
                        PRESETS.forEach((preset) => {
                            const btn = document.createElement("button");
                            btn.type = "button";
                            btn.className = "fabtuner-chip";
                            btn.textContent = preset.label;
                            btn.addEventListener("click", () => {
                                targetsInput.value = preset.notes;
                                rebuildTargets();
                                presetsEl
                                    .querySelectorAll(".fabtuner-chip")
                                    .forEach((chip) => chip.classList.remove("fabtuner-chip-active"));
                                btn.classList.add("fabtuner-chip-active");
                            });
                            frag.appendChild(btn);
                        });
                        presetsEl.appendChild(frag);
                    }

                    // initialize targets on load
                    rebuildTargets();
                    buildPresets();
                })();
            </script>
        </div>
    </div>
</body>
</html>